<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LWESS Admin</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* STYLES ADMIN SPECIFIQUES */
    .admin-section {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .admin-title {
      text-align: center;
      margin: 30px 0 50px;
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(90deg, #9d4edd, #e8b8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* STATS GRID */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 50px;
    }

    .stat-card {
      background: rgba(26, 0, 51, 0.8);
      padding: 30px;
      border-radius: 24px;
      text-align: center;
      border: 2px solid rgba(157,78,221,0.3);
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      transition: all 0.4s ease;
    }

    .stat-card:hover {
      transform: translateY(-8px);
      border-color: #9d4edd;
      box-shadow: 0 25px 50px rgba(157,78,221,0.4);
    }

    .circle-progress {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(#9d4edd var(--progress, 0%), rgba(157,78,221,0.2) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 0 auto 20px;
    }

    .circle-progress::after {
      content: '';
      position: absolute;
      width: 90px;
      height: 90px;
      background: #1a0033;
      border-radius: 50%;
    }

    .stat-number {
      position: relative;
      z-index: 1;
      font-size: 32px;
      font-weight: 900;
      color: #fff;
    }

    .stat-label {
      font-size: 18px;
      color: #e8b8ff;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-revenue {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(90deg, #9d4edd, #e8b8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }

    .small-info {
      font-size: 14px;
      color: #aaa;
    }

    /* CHART CONTAINER */
    .charts-container {
      background: rgba(26, 0, 51, 0.6);
      border-radius: 24px;
      padding: 30px;
      margin: 40px 0;
      border: 2px solid rgba(157,78,221,0.3);
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    }

    /* REFRESH BUTTON */
    .refresh-btn {
      display: block;
      margin: 30px auto;
      background: linear-gradient(45deg, #9d4edd, #c77dff);
      color: #fff;
      padding: 16px 40px;
      border: none;
      border-radius: 50px;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(157,78,221,0.4);
      transition: all 0.4s;
    }

    .refresh-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(199,125,255,0.5);
    }

    /* TABLE STYLES */
    .table-container {
      margin-top: 40px;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(26,0,51,0.6);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    }

    .admin-table th {
      background: linear-gradient(135deg, #9d4edd, #c77dff);
      color: #fff;
      padding: 20px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 16px;
    }

    .admin-table td {
      padding: 18px 16px;
      border-bottom: 1px solid rgba(157,78,221,0.2);
      font-size: 15px;
      color: #e8d9ff;
    }

    .admin-table tr:hover {
      background: rgba(157,78,221,0.15);
    }

    .revenue {
      font-weight: 700;
      color: #9d4edd !important;
    }

    .delete-btn {
      background: #ff4d4d;
      color: #fff;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-btn:hover {
      background: #ff1a1a;
      transform: scale(1.1);
    }

    .no-data, .error {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #ccc;
    }

    .error {
      color: #ff6b6b;
    }

    /* RESPONSIVE ADMIN */
    @media (max-width: 768px) {
      .admin-section {
        padding: 20px;
      }
      
      .admin-table {
        font-size: 14px;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 12px 8px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<script>
  if (localStorage.getItem('admin') !== 'true') {
    location.href = 'login.html';
  }
</script>

<header>
  <div class="logo">LWESS ADMIN</div>
  <nav>
    <ul>
      <li><a href="index.html" class="nav-link">Retour au Site</a></li>
    </ul>
  </nav>
</header>

<section class="admin-section">
  <h1 class="admin-title">Tableau de Bord Admin</h1>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="circle-progress" id="todayCircle">
        <span class="stat-number" id="todayCount">0</span>
      </div>
      <div class="stat-label">Aujourd'hui</div>
      <div class="stat-revenue" id="todayRevenue">0 DT</div>
      <div class="small-info" id="todayInfo">Chargement...</div>
    </div>
    
    <div class="stat-card">
      <div class="circle-progress" id="monthCircle">
        <span class="stat-number" id="monthCount">0</span>
      </div>
      <div class="stat-label">Ce Mois</div>
      <div class="stat-revenue" id="monthRevenue">0 DT</div>
      <div class="small-info" id="monthInfo"></div>
    </div>
  </div>

  <!-- Chart Revenu -->
  <div class="charts-container">
    <canvas id="revenueChart"></canvas>
  </div>

  <button onclick="load()" class="refresh-btn">üîÑ Actualiser</button>
  
  <div class="table-container">
    <div id="table"></div>
  </div>
</section>

<script>
let revenueChart;

async function load() {
  console.log('Chargement des donn√©es...');
  try {
    const res = await fetch('/api/reservations');
    if (!res.ok) throw new Error('API non disponible');
    const data = await res.json();

    // === STATS AUJOURD'HUI ===
    const todayCount = data.stats.today.count;
    const todayRevenue = data.stats.today.revenue;

    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('todayRevenue').textContent = todayRevenue + ' DT';

    const now = new Date();
    document.getElementById('todayInfo').textContent = `Aujourd'hui, ${now.toLocaleDateString('fr-FR')}`;
    updateCircle('todayCircle', todayCount, 20);

    // === STATS MOIS ===
    const monthCount = data.stats.month.count;
    const monthRevenue = data.stats.month.revenue;

    document.getElementById('monthCount').textContent = monthCount;
    document.getElementById('monthRevenue').textContent = monthRevenue + ' DT';
    document.getElementById('monthInfo').textContent = `Mois de ${now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
    updateCircle('monthCircle', monthCount, 100);

    // === TABLEAU DES RESERVATIONS ===
    const rows = data.list.map(r => `
      <tr>
        <td>${r.service || '‚Äî'}</td>
        <td>${r.date || '‚Äî'}</td>
        <td><strong>${r.heure || '‚Äî'}</strong></td>
        <td>${(r.client?.surname || '')} ${(r.client?.name || '')}</td>
        <td>${r.client?.phone || '‚Äî'}</td>
        <td>${Array.isArray(r.options) ? r.options.join(', ') : 'Aucune'}</td>
        <td class="revenue">${r.total || 0} DT</td>
        <td><button class="delete-btn" onclick="del('${r.date}','${r.heure || ''}')">√ó</button></td>
      </tr>
    `).join('');

    document.getElementById('table').innerHTML = rows
      ? `<table class="admin-table">
           <thead>
             <tr>
               <th>Service</th>
               <th>Date</th>
               <th>Heure</th>
               <th>Client</th>
               <th>T√©l</th>
               <th>Options</th>
               <th>Revenu</th>
               <th>Action</th>
             </tr>
           </thead>
           <tbody>
             ${rows}
           </tbody>
         </table>`
      : "<p class='no-data'>üì≠ Aucune r√©servation pour le moment</p>";

    // === CHART: Revenu par jour ===
    const days = Object.keys(data.chart.revenueByDay || {}).sort();
    const revenues = days.map(d => data.chart.revenueByDay[d] || 0);

    // Formater les dates pour l'affichage
    const formattedDays = days.map(day => {
      const date = new Date(day);
      return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    });

    if (revenueChart) revenueChart.destroy();
    
    const ctx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: formattedDays.length ? formattedDays : ['Aucune donn√©e'],
        datasets: [{
          label: 'Revenu (DT)',
          data: revenues.length ? revenues : [0],
          backgroundColor: '#9d4edd',
          borderColor: '#c77dff',
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { 
            display: false 
          },
          title: {
            display: true,
            text: 'Revenu par Jour',
            color: '#e8b8ff',
            font: { size: 18, weight: 'bold' }
          },
          tooltip: { 
            backgroundColor: '#1a0033', 
            titleColor: '#e8b8ff', 
            bodyColor: '#fff',
            borderColor: '#9d4edd',
            borderWidth: 1
          }
        },
        scales: {
          y: { 
            beginAtZero: true, 
            ticks: { color: '#ccc' }, 
            grid: { color: 'rgba(157,78,221,0.1)' } 
          },
          x: { 
            ticks: { color: '#ccc' }, 
            grid: { display: false } 
          }
        },
        animation: { 
          duration: 1200, 
          easing: 'easeOutQuart' 
        }
      }
    });

  } catch (err) {
    console.error('Erreur:', err);
    document.getElementById('table').innerHTML = 
      "<p class='error'>‚ùå Connexion perdue. V√©rifiez que le serveur est d√©marr√©.</p>";
  }
}

function updateCircle(id, value, max) {
  const circle = document.getElementById(id);
  const percent = Math.min((value / max) * 100, 100);
  circle.style.setProperty('--progress', `${percent}%`);
}

async function del(date, heure) {
  if (!heure || heure === '‚Äî') {
    alert("Heure manquante !");
    return;
  }
  
  if (confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©servation ?')) {
    try {
      const res = await fetch(`/api/delete/${date}/${heure}`, { method: 'DELETE' });
      if (res.ok) {
        load(); // Recharger les donn√©es
      } else {
        alert("Erreur lors de la suppression");
      }
    } catch (e) { 
      alert('Erreur r√©seau - V√©rifiez la connexion'); 
    }
  }
}

// Charger au d√©marrage
document.addEventListener('DOMContentLoaded', load);

// Auto-refresh toutes les 10 secondes
setInterval(() => {
  console.log("üîÑ Auto-refresh...");
  load();
}, 10000);
</script>

</body>
</html>